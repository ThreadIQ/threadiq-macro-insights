version: "3.9"

services:
  web:
    build: .
    command: >
      bash -c "cd backend && gunicorn core.asgi:application
      -k uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:8000"
    volumes: ["./backend:/app/backend"]
    ports: ["8000:8000"]
    env_file: [.env]
    depends_on: [db, redis]

  worker:
    build: .
    command: >
      bash -c "cd backend && celery -A core worker -l info
      -Q default,ingest,analyze,email
      --concurrency=6
      --prefetch-multiplier=1"
    volumes: ["./backend:/app/backend"]
    env_file: [.env]
    depends_on: [db, redis]

  beat:
    build: .
    command: bash -c "cd backend && celery -A core beat -l info --pidfile= --schedule=/tmp/celerybeat-schedule.db"
    volumes: ["./backend:/app/backend"]
    env_file: [.env]
    depends_on: [db, redis]

  db:
    image: postgres:16
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: threadiq
      POSTGRES_USER: threadiq
      POSTGRES_PASSWORD: threadiq
    ports: ["5432:5432"]

  redis:
    volumes:
      - redis_data:/data
    image: redis:7
    ports: ["6379:6379"]

  weaviate:
    image: semitechnologies/weaviate:1.22.4
    restart: always
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'text2vec-openai'
      ENABLE_MODULES: 'text2vec-openai'
      CLUSTER_HOSTNAME: 'node1'
      OPENAI_APIKEY: ${OPENAI_API_KEY}
      OPENAI_ORGANIZATION: ${OPENAI_ORG_ID}
    volumes:
      - weaviate_data:/var/lib/weaviate
    depends_on:
      - db

  adminer:
    image: adminer
    restart: always
    ports:
      - "8081:8080"
    depends_on:
      - db

volumes:
  weaviate_data:
  db_data:
  redis_data: